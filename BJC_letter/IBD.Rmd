---
title: "IBD-cohort"
author: "Yilu"
date: "06/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


load packages
```{r,echo=FALSE}
library(CEMiTool)
library(dplyr)
library(janitor)
library(doParallel) ##
registerDoParallel(cores=4)
library(preprocessCore)
```
for (i in 1:681){
  IBD_meta$[i]<-paste0(IBD_meta$Class[i],'_',i)
}

for (i in 682:1049){
  IBD_meta$Class[i]<-paste0(IBD_meta$Class[i],'_',(i-681))
}

laod data
```{r, echo=FALSE}

IBD_meta<-read.table('/Users/yihuawang/Downloads/IBD_sub.txt',header = T,sep = '\t') %>% 
  filter(Diagnosis=='CD' | Diagnosis=='UC')%>%
  rename('SampleName'='IID',
         'Class'='Diagnosis')%>%
  arrange(., Class)

print(table(IBD_meta$Class))
#CD  UC 
#681 368

IBD<-read.table('/Users/yihuawang/Downloads/GENEPY_JULY2021_all.matrix.txt',header = T,sep = '\t',stringsAsFactors = F) %>%
  t() %>% 
  as.data.frame() %>%
  row_to_names(row_number = 1)%>%
  select(IBD_meta$SampleName)
IBD[,1:1049] <- sapply(IBD[,1:1049], as.numeric) # 9130 genes with 0 expression in IBD[,1]



mads=apply(IBD,1,mad) ### measured by median absolute deviation
IBD_mad=IBD[rev(order(mads))[1:5000],] ### top 5000 variable genes
IBD_mad = sweep(IBD_mad,1, apply(IBD_mad,1,median,na.rm=T))
```


```{r}
IBD2<-normalize.quantiles(as.matrix(IBD))
rownames(IBD2)<-rownames(IBD)
colnames(IBD2)<-colnames(IBD)
IBD3<-log(IBD2)

```




construct a CEMiTool object with both expression data and sample annotation:
```{r}

```

run CEMiTool
```{r}
# # run cemitool with sample annotation
cem <- cemitool(as.data.frame(IBD3), IBD_meta,
                cor_method =  "spearman")

```


```{r}

powers = c(c(1:10), seq(from = 12, to=20, by=2))
sft = pickSoftThreshold(IBD_mad, 
                        powerVector = powers, verbose = 5)
pdf(file = paste("SFTPlot2.pdf",sep = "."),width = 10,height = 7)
par(mfrow = c(1,2));
cex1 = 0.9;
plot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     xlab="Soft Threshold (power)",ylab="Scale Free Topology Model Fit,signed R^2",type="n",
     main = paste("Scale independence"));
text(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2],
     labels=powers,cex=cex1,col="red");
# this line corresponds to using an R^2 cut-off of h
#abline(h=0.90,col="red")
abline(h=0.85,col="blue")
# Mean connectivity as a function of the soft-thresholding power
plot(sft$fitIndices[,1], sft$fitIndices[,5],
     xlab="Soft Threshold (power)",ylab="Mean Connectivity", type="n",
     main = paste("Mean connectivity"))
text(sft$fitIndices[,1], sft$fitIndices[,5], labels=powers, cex=cex1,col="red")
dev.off()


```
```{r}
#### WGCNA step by step ####
datExpr<-IBD_mad
softPower = 5
adjacency = adjacency(datExpr, power = softPower,type='signed hybrid')
?adjacency
## Topological Overlap Matrix (TOM)
TOM = TOMsimilarity(adjacency,
                    TOMType = "signed")
dissTOM = 1-TOM
## Clustering using TOM
geneTree = hclust(as.dist(dissTOM), method = "average")#
# Plot the resulting clustering tree (dendrogram)
pdf('WGCNA_geneTree_Signhybrid.pdf',width = 100,height = 10)
plot(geneTree, xlab="", sub="", main = "Gene clustering on TOM-based dissimilarity",
     labels = FALSE, hang = 0.04)
dev.off()
# We like large modules, so we set the minimum module size relatively high:
minModuleSize = 100
# Module identification using dynamic tree cut:
dynamicMods = cutreeDynamic(dendro = geneTree, distM = dissTOM,
                            deepSplit = 2, pamRespectsDendro = FALSE,
                            minClusterSize = minModuleSize);
table(dynamicMods)
# Convert numeric lables into colors
dynamicColors = labels2colors(dynamicMods)
table(dynamicColors)
# Plot the dendrogram and colors underneath
sizeGrWindow(8,6)
pdf('WGCNA_geneTree_100.pdf',width = 100,height = 10)
plotDendroAndColors(geneTree, dynamicColors, "Dynamic Tree Cut",
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide = TRUE, guideHang = 0.05,
                    main = "Gene dendrogram and module colors")
dev.off()
# Calculate eigengenes
MEList = moduleEigengenes(datExpr, colors = dynamicColors)
MEs = MEList$eigengenes
MEDiss = 1-cor(MEs);
# Cluster module eigengenes
METree = hclust(as.dist(MEDiss), method = "average")
MEDissThres = 0.25
plotEigengeneNetworks(MEs, 
                      "Eigengene adjacency heatmap", 
                      marHeatmap = c(3,4,2,2), 
                      plotDendrograms = FALSE, 
                      xLabelsAngle = 90) 
# Calculate dissimilarity of module eigengenes
# Plot the result
pdf('WGCNA_MergedgeneTree_100.pdf',width = 100,height = 10)
plot(METree, main = "Clustering of module eigengenes",
     xlab = "", sub = "")
abline(h=MEDissThres, col = "red")
dev.off()
# Call an automatic merging function
merge = mergeCloseModules(datExpr, dynamicColors, cutHeight = MEDissThres, verbose = 3)
# The merged module colors
mergedColors = merge$colors;
# Eigengenes of the new merged modules:
mergedMEs = merge$newMEs
table(mergedColors)
pdf('WGCNA_MergedgeneTree_new_100.pdf',width = 10,height = 10)
plotDendroAndColors(geneTree, cbind(dynamicColors, mergedColors),
                    c("Dynamic Tree Cut", "Merged dynamic"),
                    dendroLabels = FALSE, hang = 0.03,
                    addGuide = TRUE, guideHang = 0.05)
dev.off()
```

Trouble interpreting differences in hub genes from interaction networks
https://github.com/csbl-usp/CEMiTool/issues/78
I admit it's a bit confusing at first, but the way it works is: blue is if your gene is a hub considering edges in your module only, green is if it is a hub considering both your module and interaction file edges, red if it is a hub in the interaction file edges only. In other words, being in the module or the interaction file is not enough, they must be hubs in both to warrant the green color. Does that make sense?

To sum up, blue ones are module hub genes, red ones are interaction database hub genes, but green ones are hubs in both our module and interaction database.

```{r}
bwnet = blockwiseModules(IBD, maxBlockSize = 2000,
                     power = 4, TOMType = "unsigned", minModuleSize = 30,
reassignThreshold = 0, mergeCutHeight = 0.25, numericLabels = TRUE,
saveTOMs = TRUE,
saveTOMFileBase = "femaleMouseTOM-blockwise", verbose = 3)
```

```{r}
library("CEMiTool")
data(expr0)
head(expr0[,1:4])
cem <- cemitool(expr0, sample_annot)
cem
```

```{r}
gmt_fname <- system.file("extdata", "pathways.gmt", package = "CEMiTool")
gmt_in <- read_gmt(gmt_fname)
cem <- mod_ora(cem, gmt_in)
int_fname <- system.file("extdata", "interactions.tsv", package = "CEMiTool")
int_df <- read.delim(int_fname)
head(int_df)
```

```{r}
library(ggplot2)
interactions_data(cem) <- int_df # add interactions
cem <- plot_interactions(cem) # generate plot
plots <- show_plot(cem, "interaction") # view the plot for the first module
plots[1]
```
```{r}
library(ggplot2)
cem <- cemitool(expr0, sample_annot, gmt_in, interactions=int_df, 
                filter=TRUE, plot=TRUE, verbose=TRUE)
# create report as html document
generate_report(cem, directory="./Report")

# write analysis results into files
write_files(cem, directory="./Tables")

# save all plots
save_plots(cem, "all", directory="./Plots")
```



